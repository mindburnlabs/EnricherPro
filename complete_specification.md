# КРИТИЧЕСКОЕ ПЕРЕПИСАННОЕ ТЗ (ПОЛНАЯ ВЕРСИЯ)
## Автоматизация обогащения расходников: от названия → готовая карточка товара

---

## 1) ЦЕЛЬ И ЗОНА ПРИМЕНЕНИЯ

Автоматически преобразовывать "Название товара от поставщика" в готовую структурированную карточку расходного материала для печати (PIM/1C/CRM/маркетплейсы).

**Результат включает:**
- Нормализованные атрибуты расходника (модель, тип, бренд, ресурс, цвет, чип/счётчик)
- Размеры и вес упаковки (строго из NIX.ru)
- Полный список совместимых принтеров с ограничением "РФ-допуск"
- Список "Похожие товары" (другие расходники для этих принтеров)
- Валидированное изображение товара
- Полная трассировка источников (для аудита)

**Ключевое требование:** Одинаковый вход → одинаковый выход при неизменных правилах (детерминированность).

---

## 2) ВХОДНЫЕ ДАННЫЕ

### Минимально необходимые входы:
- `supplier_title` — строка названия (обязательно)
- `supplier_sku` — артикул поставщика (опционально)
- `supplier_brand` — бренд, если выделен отдельно (опционально)
- `source_ref` — ссылка на прайс/файл (желательно для аудита)

### Что сохранять:
- `supplier_title_raw` — оригинал БЕЗ изменений
- `title_norm` — нормализованная копия для парса (рабочая версия)

---

## 3) НОРМАЛИЗАЦИЯ ВХОДНОЙ СТРОКИ (ОБЯЗАТЕЛЬНО)

Для `title_norm` выполнить (но НЕ менять `supplier_title_raw`):

1. **Unicode-нормализация** (NFC) + удаление двойных пробелов и неразрывных пробелов
2. **Приведение разделителей** к единому виду (`,`, `;`, `\`, `|` → всё в `/`)
3. **Нормализация ресурса**:
   - `15K`, `15k`, `15 K`, `15 к`, `15К` → 15000
   - `300К`, `300 K`, `300k` → 300000
4. **Нормализация типа расходника**:
   - "драм-картридж", "фотобарабан", "drum", "drum unit" → `drum_unit`
   - "картридж", "тонер", "toner cartridge" → `toner_cartridge`
5. **Нормализация цвета**:
   - `Bk`, `Black`, `Черный`, `Чёрный` → `Black`
   - `C`, `Cyan`, `Голубой` → `Cyan`
   - И т.п.

**Важно:** Не трогаем коды моделей, только форматируем для парса.

---

## 4) ПАРСИНГ: ИЗВЛЕЧЕНИЕ ИЗ НАЗВАНИЯ

### 4.1 Модель расходника (обязательно)
**Выход:** `consumable_model_main`, `consumable_model_candidates[]`

Правила:
- Найти все кандидаты формата "буквы+цифры+суффиксы" (DK-7105, W1331X, Q2612A и т.п.)
- Если много кандидатов, выбрать по приоритетам:
  1. Соответствие паттерну известного бренда (если бренд известен)
  2. Ближайший к словам "картридж", "фотобарабан", "toner", "drum"
  3. Самый специфичный (длиннее, с суффиксами)
- Если конфликт неразрешим → `automation_status = needs_review`

### 4.2 Бренд принтера (обязательно)
**Выход:** `printer_brand`

Правила:
- Если явно в названии (HP, Kyocera, Canon и т.д.) → берём
- Иначе определяем по модели расходника (словарь префиксов/паттернов)
- Если не удалось → `automation_status = failed`

### 4.3 Тип расходника (обязательно)
**Выход:** `consumable_type` ∈ {toner_cartridge, drum_unit, ink_cartridge, maintenance_kit, waste_toner, other, unknown}

Правила:
- Ключевые слова + паттерны модели (DK-… обычно drum, W…/Q…/TK-… обычно toner)
- Если конфликт → `unknown` и `needs_review`

### 4.4 Модели принтеров из названия (кандидаты)
**Выход:** `printer_models_from_title[]`

Правила:
- Всё после "для"/"for" + перечисления (Laser 408/432, TASKalfa 3010i/3011i/...)
- Это кандидаты, финально проверим источниками

### 4.5 Ресурс печати (если есть)
**Выход:** `yield_value`, `yield_unit` ∈ {pages, copies}

Правила:
- Извлечь число + определить единицу ("стр." → pages, "копий" → copies)
- Если не указано → `yield_* = null` (нормально)

### 4.6 Цвет (если применимо)
**Выход:** `consumable_color`

Правила:
- Black, Cyan, Magenta, Yellow и т.п.
- Распознавать: Bk, C/M/Y/K, "Чёрный", "Пурпурный" и т.д.

### 4.7 Чип/счётчик (если указано)
**Выход:** `has_chip`, `has_page_counter` ∈ {true, false, unknown}

Правила:
- "С ЧИПОМ" → `has_chip=true`
- "БЕЗ ЧИПА" → `has_chip=false`
- "БЕЗ СЧЕТЧИКА" → `has_page_counter=false`
- Если не указано → `unknown`

---

## 5) ОБОГАЩЕНИЕ ДАННЫХ (ИСТОЧНИКИ И ПРАВИЛА)

### 5.1 Сокращённое/дополнительное название модели (alias)
**Выход:** `model_alias_short`, `alias_confidence`

Примеры: Q2612A → 12A, C8727AE → HP 27

Алгоритм:
1. Поиск в `known_aliases` словаре (основной метод)
2. Эвристика опционально, но с пометкой `alias_confidence=low`
3. Если не найдено → `null` (нормально)

### 5.2 Размеры и вес упаковки (КРИТИЧЕСКИЙ)
**Выход:** `package_dimensions_mm` {length, width, height}, `package_weight_g`
**Источник:** ТОЛЬКО NIX.ru

Алгоритм:
1. Запрос на NIX.ru по модели + бренд
2. Извлечение: размеры (см) → конвертируем в мм (×10)
3. Извлечение: вес (кг) → конвертируем в г (×1000)
4. Сохранить сырьё: `package_dimensions_raw`, `package_weight_raw`, ссылку в `sources[]`

Фолбэк:
- Если нет на NIX.ru → `automation_status = needs_review` (публикация запрещена)

**Пример конвертации:**
- 35×35×35 см → 350×350×350 мм
- 2.4 кг → 2400 г

### 5.3 Совместимые принтеры (финальный список)
**Выход:** `compatible_printers_ru[]`, `compatible_printers_unverified[]`
**Источники:** cartridge.ru, rashodnika.net, OEM (HP, Canon, Epson, Kyocera, Brother)

Алгоритм:
1. **Сбор кандидатов** из всех источников
2. **Нормализация** названий принтеров (канонический вид: бренд + серия + индекс + суффиксы)
3. **Фильтр РФ**: Каждый принтер должен быть в ≥2 RU-источниках ИЛИ в OEM RU → `ru_verified=true`
4. **Остальные** → `compatible_printers_unverified[]` (не показывать на витрине, но хранить)
5. **Дедупликация** (Laser 408 vs 408dn: отдельные записи, если суффикс важен)

Политика разрешения конфликтов:
- `compatibility_merge_policy = union_with_provenance` (по умолчанию)
- `min_sources_required`: OEM = 1, остальное = 2+

Если конфликт → `compat_conflict=true`, карточка → `needs_review`

### 5.4 "Похожие товары" (дополнительные расходники)
**Выход:** `related_consumables_full[]`, `related_consumables_display[]`

Алгоритм:
1. Взять `compatible_printers_ru[]`
2. Для каждого принтера собрать все расходники (rashodnika.net / cartridge.ru)
3. Нормализовать модели, исключить текущий расходник, дедуплицировать
4. `related_consumables_full[]` = полный список
5. `related_consumables_display[]` = топ 8–12 для витрины (по приоритету: тот же тип, затем смежные)

### 5.5 Изображение товара
**Выход:** `product_image_main` (url/file_id), `image_validation` (результаты проверок), `image_source`

Требования к изображению:
- ✅ Минимум 800×800 px
- ✅ Только картридж (без упаковки, без посторонних предметов)
- ✅ Совместимый (не оригинальный) — это гарантирует политика источника
- ✅ Белый фон
- ✅ Без водяных знаков
- ✅ Без товарных знаков / логотипов / бренд-надписей

Политика источника (выбрать одну):
- `approved_library_only` (рекомендуется) — только ваша проверенная БД
- `supplier_plus_moderation` — от поставщика + авто-проверки + ручная модерация

Авто-валидация:
- Проверка разрешения (>= 800×800) ✅
- Детекция белого фона (порог > 80% белых в углах) ✅
- Детекция упаковки / посторонних объектов (отклонить если найдено) ✅
- OCR + логотип-детектор (HP, Canon, Kyocera и т.д. — отклонить) ✅
- Детекция водяных знаков (отклонить) ✅

Фолбэк:
- Если не пройдено → отклонить из текущего источника, попробовать другое
- Если нет валидного → карточка создаётся, но `publish_ready=false`, `automation_status=needs_review`

---

## 6) СТАТУСЫ, ОШИБКИ И РУЧНАЯ ОЧЕРЕДЬ

### 6.1 Классы ошибок
- `failed_parse_model` — не извлечена модель
- `failed_parse_type` — не определён тип
- `failed_parse_brand` — не определён бренд
- `missing_nix_dimensions_weight` — нет размеров/веса по NIX.ru
- `compatibility_conflict` — конфликт источников по совместимости
- `ru_eligibility_unknown` — не доказан РФ-допуск
- `missing_valid_image` — нет валидного изображения

### 6.2 Статусы карточки
- `done` — готова к публикации (все обязательные поля заполнены, валидны)
- `needs_review` — требует ручной проверки/дополнения (часть полей не получена)
- `failed` — не распознана (не извлечена модель, бренд и т.д.)

### 6.3 Ручная очередь (обязательная часть)
Для каждого `needs_review`:
- Входное название + нормализованное
- Текущие извлечённые значения
- Недостающие поля + их обязательность
- Ссылки на попытки источников
- Рекомендация для оператора ("Найти на NIX.ru", "Подтвердить совместимость" и т.д.)

---

## 7) ЛОГИРОВАНИЕ, АУДИТ, ВЕРСИИ

Для каждого запуска хранить:
- `job_run_id` — уникальный ID запуска
- `input_hash` — хеш входных данных
- `ruleset_version` — версия правил парса
- `parser_version` — версия парсера
- `sources[]` по каждому полю (URL, timestamp, что подтверждено)
- Трассировка шагов (лог) с причинами фильтрации

Требование к мониторингу:
- % успешно обогащённых (целевое > 95%)
- % в `needs_review` (тренд)
- Среднее время обогащения (целевое < 15 сек с кешем)
- Доступность источников (алерты при > 1 часа недоступности)

---

## 8) КРИТЕРИИ ПРИЁМКИ (Definition of Done)

Карточка готова к публикации (`publish_ready=true`), если:

### Обязательные поля (без них → needs_review/failed):
- ✅ `consumable_model_main` — извлечена и валидна
- ✅ `consumable_type` — определён (не unknown)
- ✅ `printer_brand` — определён
- ✅ `package_dimensions_mm` — с NIX.ru, конвертировано в мм
- ✅ `package_weight_g` — с NIX.ru, конвертировано в г
- ✅ `compatible_printers_ru[]` — сформирован по РФ-критериям (может быть пустым только если отправлена в needs_review)

### Рекомендуемые поля (могут быть null):
- `model_alias_short` — если найдено на рынке
- `yield_value`, `yield_unit` — если было в названии
- `consumable_color` — если применимо
- `has_chip`, `has_page_counter` — если указано
- `related_consumables_display[]` — сформирован из full

### Изображение (в зависимости от политики):
- Approved Library: если найдено и прошло проверки → OK; иначе `publish_ready=false`
- Supplier+Moderation: если поставщик дал → проверить; иначе `publish_ready=false`

### Sources:
- Каждое обогащённое поле должно иметь ссылку на источник в `sources[]`

---

## 9) ТЕСТОВЫЕ ПРИМЕРЫ (для автотестов)

1. **"Картридж HP W1331X С ЧИПОМ БЕЗ СЧЕТЧИКА laser-408/432 15K"**
   - Ожидается: модель W1331X, тип toner, бренд HP, ресурс 15000 страниц, чип true, счётчик false, принтеры HP Laser 408/432, размер/вес с NIX

2. **"Драм-картридж Kyocera DK-7105 для TASKalfa 3010i/3011i/3510i/3511i, Bk, 300К"**
   - Ожидается: модель DK-7105, тип drum_unit, бренд Kyocera, цвет Black, ресурс 300000 копий, принтеры TASKalfa 3010i/3011i/3510i/3511i, размер/вес с NIX

3. **"ХрN W1331X 331X"** (грязное название)
   - Ожидается: парсер должен извлечь W1331X, определить HP, toner, рекомендовать ручную проверку если нет принтеров

4. **"Картридж Canon 045 для imageCLASS MF642Cdw/MF643Cdw LBP611Cn"**
   - Ожидается: модель 045, бренд Canon, toner, принтеры из названия + расширение с cartridge.ru

---

## 10) КОНФИГ ПАРАМЕТРОВ (YAML)

```yaml
sources:
  oem_priority: 1
  cartridge_ru:
    rate_limit_delay_sec: 1
    ttl_days: 3
  rashodnika_net:
    rate_limit_delay_sec: 0.5
    ttl_days: 7
  nix_ru:
    rate_limit_delay_sec: 2
    required: true
    ttl_days: 7

compatibility:
  merge_policy: "union_with_provenance"
  min_sources_for_ru_verified: 2
  priority_order: ["oem", "cartridge_ru", "rashodnika_net"]

images:
  mode: "approved_library_only"  # или "supplier_plus_moderation"
  validation:
    min_size_px: 800
    white_bg_threshold: 0.8
    logo_detection: true
    watermark_detection: true

logging:
  level: "INFO"
  format: "json"
  store_sources: true
```

---

## ИТОГ

Это **полное и формализованное ТЗ** для 100% воспроизводимой автоматизации. Каждый параметр, правило, фолбэк и критерий определён так, чтобы:
- ✅ Система была детерминированной
- ✅ Ошибки классифицировались и логировались
- ✅ Ручная очередь была предсказуемой и управляемой
- ✅ Качество данных было измеримым

Используйте в N8N / Make / Python пайплайне напрямую.
